<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodorus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: auto; /* ou remova esta linha */
            padding-top: 2vh; /* Ajuste este valor confor */
            background-color: #e0f7fa; /* Um azul claro suave */
            margin: 0;
            color: #333;
            flex-direction: column; /* Para alinhar o container principal e os carrosséis */
        }

        .alarm-container {
            background-color: #ffffff;
            padding: 40px;
            padding-top: 00px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px; /* Espaço entre o container do alarme e os overlays de seleção */
        }

        h1 {
            color: #00796b; /* Um verde-azulado mais escuro */
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        .time-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #263238;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }

        /* --- Regras para o Botão de Ação --- */
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            color: #ffffff;
            background-color: #00796b; /* Botão verde-azulado */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 121, 107, 0.3);
            margin-top: 30px; /* Adicionado para separar o botão das opções de pausa */
            margin-bottom: 15px; /* Espaço entre o botão e a mensagem de status */
        }
        button:hover {
            background-color: #004d40; /* Verde-azulado mais escuro no hover */
            transform: translateY(-3px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .status-message {
            margin-top: 0; /* Ajustado, pois a margem já está no botão */
            font-size: 1em;
            color: #d32f2f; /* Vermelho para mensagens de status */
            font-weight: bold;
        }

        /* --- CSS do Carrossel --- */
        .carousel-container {
            position: relative;
            margin: 10px;
        }
        .carousel {
            position: relative;
            width: 80px; /* Largura para o valor */
            height: 50px;
            overflow: hidden;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            background-color: #fff;
            box-sizing: border-box;
        }
        .carousel .items-container {
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 28px);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            transition: transform 0.2s ease-out;
            padding-left: 22px;
            box-sizing: border-box;
            cursor: pointer;
            z-index: 5;
        }
        .carousel .item {
            min-width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            font-size: 24px;
            box-sizing: border-box;
            color: #555;
            transform: translateX(-5px);
        }
        .carousel .item.selected {
            color: #00796b;
            font-weight: bold;
            transform: scale(1.1) translateX(-5px);
        }
        .carousel-buttons {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 28px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            border-left: 1px solid #eee;
            background-color: #f8f8f8;
            border-radius: 0 5px 5px 0;
            z-index: 10;
        }
        .carousel-button {
            width: 100%;
            height: 49%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #555;
            user-select: none;
            transition: background-color 0.1s ease-out, color 0.1s ease-out;
            border: none;
            background: none;
            padding: 0;
        }
        .carousel-button:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        .carousel-button:active {
            transform: translateY(0);
            box-shadow: none;
            background-color: #d0d0d0;
            color: #000;
        }
        .carousel-button.up {
            border-bottom: 1px solid #eee;
        }
        .carousel-button.down {
            border-top: 1px solid #eee;
        }

        /* --- Overlay para seleções --- */
        .selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 151;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        .selection-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .selection-carousel {
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            width: 100px;
            height: 90vh;
            max-height: 90vh;
            overflow: hidden;
        }
        .selection-carousel .selection-items-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            transition: transform 0.2s ease-out;
            padding-top: 100px;
            padding-bottom: 100px;
        }
        .selection-carousel .item {
            min-width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-sizing: border-box;
            cursor: pointer;
            color: #555;
            transition: color 0.1s ease-out, transform 0.1s ease-out, font-size 0.1s ease-out;
        }
        .selection-carousel .item:hover {
            font-size: 28px;
            transform: scale(1.1);
            color: #00796b;
        }
        .selection-carousel .item.selected-overlay-item {
            background-color: #e0f7fa;
            color: #00796b;
            font-weight: bold;
        }

        /* --- Regras para o form-group principal (simplificado) --- */
        .form-group {
            background-color: #f8fcfd;
            padding: 25px;
            border-radius: 10px;
            margin-top: 25px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
            padding-bottom: 30px;
        }

        .form-group > .section-title {
            font-size: 1.5em;
            color: #004d40;
            margin-bottom: 30px;
            border-bottom: 3px solid #b2dfdb;
            padding-bottom: 12px;
        }

        .input-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .input-group > label {
            display: block;
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
            color: #546e7a;
        }

        /* --- Regras para os novos Modais de Configuração de Pausa --- */
        .config-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150; /* Acima dos carrosséis de seleção, abaixo do Gist modal */
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        .config-modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .config-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px; /* Largura similar ao alarm-container */
            text-align: center;
        }
        .config-modal-content h3 {
            color: #00796b;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .config-modal-content .modal-buttons {
            display: flex;
            justify-content: space-around; /* Espaçamento entre os botões */
            gap: 10px;
            margin-top: 30px;
        }
        .config-modal-content .modal-buttons button {
            margin-top: 0;
            padding: 10px 20px;
            font-size: 1em;
        }
        .config-modal-content .modal-buttons .nav-button { /* Botões Avançar/Voltar */
            background-color: #42a5f5; /* Um azul mais claro */
        }
        .config-modal-content .modal-buttons .nav-button:hover {
            background-color: #1976d2;
        }
        .config-modal-content .modal-buttons .define-button { /* Botão Definir Pausa final */
            background-color: #00796b;
        }

        /* --- Estilos para os campos de rádio e checkbox dentro do modal --- */
        .modal-radio-options, .modal-checkbox-option {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .modal-radio-options .radio-option, .modal-checkbox-option .radio-option {
             /* Reutiliza estilos de .radio-option */
             margin-bottom: 0; /* Remove margem extra */
        }
        .modal-input-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        .modal-input-group > label {
            display: block;
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
            color: #546e7a;
        }
        /* Ajuste para carrosséis dentro de modais */
        .config-modal-content .carousel-container {
            margin: 5px; /* Espaçamento menor dentro do modal */
        }


        /* --- Seção de Pausas Ativas --- */
        #active-pauses-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0fcfc;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }

        #active-pauses-section .section-title {
            font-size: 1.5em;
            color: #004d40;
            margin-bottom: 20px;
            border-bottom: 2px solid #b2dfdb;
            padding-bottom: 10px;
        }

        #pauses-list {
            list-style: none;
            padding: 0;
            max-height: 200px; /* Para rolagem se houver muitas pausas */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fff;
        }

        #pauses-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
            color: #444;
        }

        #pauses-list li:last-child {
            border-bottom: none;
        }

        #pauses-list li span {
            flex-grow: 1;
            text-align: left;
        }

        #pauses-list li .remove-pause-button {
            background-color: #ef5350; /* Vermelho suave */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
        }

        #pauses-list li .remove-pause-button:hover {
            background-color: #d32f2f; /* Vermelho mais escuro */
        }
        
        /* --- Modal para Gist Config --- */
        .gist-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* Acima de todos os outros modais */
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        .gist-modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .gist-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 450px;
            text-align: left;
        }
        .gist-modal-content h3 {
            color: #00796b;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .gist-modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }
        .gist-modal-content input[type="text"],
        .gist-modal-content input[type="password"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        .gist-modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .gist-modal-content .modal-buttons button {
            margin-top: 0;
            padding: 10px 20px;
            font-size: 1em;
        }
        .gist-modal-content .modal-buttons .cancel-button {
            background-color: #90a4ae;
        }
        .gist-modal-content .modal-buttons .cancel-button:hover {
            background-color: #607d8b;
        }
    </style>
</head>
<body>
    <div class="alarm-container">
        <h1>My Pomodorus</h1>
        <div id="clock" class="time-display"></div>

        <div class="form-group">
            <div class="section-title">Ações de Pausa:</div>
            
            <button id="openPauseConfigModalButton">Configurar Nova Pausa</button>
            <p id="alarmDisplay" class="status-message"></p>
        </div>

        <button id="manageGistButton" style="margin-top: 20px; background-color: #1976d2;">Carregar/Salvar Pausas (Gist)</button>

        <div id="active-pauses-section">
            <div class="section-title">Pausas Ativas:</div>
            <ul id="pauses-list">
                </ul>
        </div>
    </div>

    <div class="selection-overlay" id="initial-pause-hour-selection-overlay">
        <div class="selection-carousel">
            <div class="selection-items-container" id="initial-pause-hour-selection-items"></div>
        </div>
    </div>
    <div class="selection-overlay" id="initial-pause-minute-selection-overlay">
        <div class="selection-carousel">
            <div class="selection-items-container" id="initial-pause-minute-selection-items"></div>
        </div>
    </div>
    <div class="selection-overlay" id="pause-duration-hour-selection-overlay">
        <div class="selection-carousel">
            <div class="selection-items-container" id="pause-duration-hour-selection-items"></div>
        </div>
    </div>
    <div class="selection-overlay" id="pause-duration-minute-selection-overlay">
        <div class="selection-carousel">
            <div class="selection-items-container" id="pause-duration-minute-selection-items"></div>
        </div>
    </div>
    <div class="selection-overlay" id="pause-end-hour-selection-overlay">
        <div class="selection-carousel">
            <div class="selection-items-container" id="pause-end-hour-selection-items"></div>
        </div>
    </div>
    <div class="selection-overlay" id="pause-end-minute-selection-overlay">
        <div class="selection-carousel">
            <div class="selection-items-container" id="pause-end-minute-selection-items"></div>
        </div>
    </div>

    <div class="config-modal-overlay" id="modal-initial-time">
        <div class="config-modal-content">
            <h3>Definir Hora de Início da Pausa:</h3>
            <div class="modal-input-group">
                <div class="carousel-container">
                    <div class="carousel" id="modal-initial-pause-hour-carousel">
                        <div class="items-container" id="modal-initial-pause-hour-items"></div>
                        <div class="carousel-buttons">
                            <div class="carousel-button up" data-direction="up">︿</div>
                            <div class="carousel-button down" data-direction="down">﹀</div>
                        </div>
                    </div>
                </div>
                <div class="carousel-container">
                    <div class="carousel" id="modal-initial-pause-minute-carousel">
                        <div class="items-container" id="modal-initial-pause-minute-items"></div>
                        <div class="carousel-buttons">
                            <div class="carousel-button up" data-direction="up">︿</div>
                            <div class="carousel-button down" data-direction="down">﹀</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="modal-initial-time-next" class="nav-button">Avançar</button>
            </div>
        </div>
    </div>

    <div class="config-modal-overlay" id="modal-pause-details">
        <div class="config-modal-content">
            <h3>Detalhes da Pausa:</h3>
            
            <div class="modal-radio-options">
                <div class="radio-option">
                    <input type="radio" id="modal-pause-mode-duration" name="modal-pause-end-type" value="duration" checked>
                    <label for="modal-pause-mode-duration">Duração da pausa:</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="modal-pause-mode-end-time" name="modal-pause-end-type" value="end-time">
                    <label for="modal-pause-mode-end-time">Hora de término:</label>
                </div>
            </div>

            <div id="modal-campos-duracao" class="modal-input-group">
                <label>Duração (Hora:Minuto):</label>
                <div class="carousel-container">
                    <div class="carousel" id="modal-pause-duration-hour">
                        <div class="items-container" id="modal-pause-duration-hour-items"></div>
                        <div class="carousel-buttons">
                            <div class="carousel-button up" data-direction="up">︿</div>
                            <div class="carousel-button down" data-direction="down">﹀</div>
                        </div>
                    </div>
                </div>
                <div class="carousel-container">
                    <div class="carousel" id="modal-pause-duration-minute">
                        <div class="items-container" id="modal-pause-duration-minute-items"></div>
                        <div class="carousel-buttons">
                            <div class="carousel-button up" data-direction="up">︿</div>
                            <div class="carousel-button down" data-direction="down">﹀</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modal-campos-fim" class="modal-input-group" style="display: none;">
                <label>Hora de Término (Hora:Minuto):</label>
                <div class="carousel-container">
                    <div class="carousel" id="modal-pause-end-hour">
                        <div class="items-container" id="modal-pause-end-hour-items"></div>
                        <div class="carousel-buttons">
                            <div class="carousel-button up" data-direction="up">︿</div>
                            <div class="carousel-button down" data-direction="down">﹀</div>
                        </div>
                    </div>
                </div>
                <div class="carousel-container">
                    <div class="carousel" id="modal-pause-end-minute">
                        <div class="items-container" id="modal-pause-end-minute-items"></div>
                        <div class="carousel-buttons">
                            <div class="carousel-button up" data-direction="up">︿</div>
                            <div class="carousel-button down" data-direction="down">﹀</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-checkbox-option" style="margin-top: 20px;">
                <input type="checkbox" id="modal-daily-repeat-checkbox">
                <label for="modal-daily-repeat-checkbox">Repetição Diária (requer Gist)</label>
            </div>

            <div class="modal-buttons">
                <button id="modal-details-back" class="nav-button">Voltar</button>
                <button id="modal-details-define" class="define-button">Definir Pausa</button>
            </div>
        </div>
    </div>

    <div class="gist-modal-overlay" id="gist-config-modal">
        <div class="gist-modal-content">
            <h3>Configurar Gist do GitHub</h3>
            <p>Para carregar ou salvar pausas com repetição diária, forneça seu Token de Acesso Pessoal (PAT) do GitHub e o ID do Gist.</p>
            <label for="gist-token">Token de Acesso Pessoal (PAT):</label>
            <input type="password" id="gist-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
            <label for="gist-id">ID do Gist:</label>
            <input type="text" id="gist-id" placeholder="Ex: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6">
            <div class="modal-buttons">
                <button id="cancelGistConfig" class="cancel-button">Cancelar</button>
                <button id="saveGistConfig">Salvar e Carregar</button>
            </div>
        </div>
    </div>

    <script>
    
// --- VARIÁVEIS GLOBAIS E REFERÊNCIAS DE ELEMENTOS ---

// Carrosséis da tela principal (se aplicável, com base no seu HTML)
const mainHourCarousel = null; // Substitua com a instância real se houver
const mainMinuteCarousel = null; // Substitua com a instância real se houver

// Elementos da UI principal
const clockDisplay = document.getElementById('clock-display');
const alarmDisplay = document.getElementById('alarm-display');
const currentPauseDisplay = document.getElementById('current-pause-display');
const nextPauseDisplay = document.getElementById('next-pause-display');
const pausesList = document.getElementById('pauses-list'); // Lista de pausas configuradas

// Botões da UI principal
const openPauseConfigModalButton = document.getElementById('open-pause-config-modal');
const manageGistButton = document.getElementById('manage-gist-button'); // Botão para abrir o modal do Gist

// Modais
const modalInitialTime = document.getElementById('modal-initial-time'); // Primeiro modal de configuração de pausa
const modalPauseDetails = document.getElementById('modal-pause-details'); // Segundo modal de configuração de pausa
const gistConfigModal = document.getElementById('gist-config-modal'); // Modal de configuração do Gist

// Referências para valores dos carrosséis do primeiro modal (hora inicial da pausa)
const initialPauseHourRef = { value: 0 };
const initialPauseMinuteRef = { value: 0 };

// Referências para valores dos carrosséis do segundo modal (duração da pausa)
const modalPauseDurationHourRef = { value: 0 };
const modalPauseDurationMinuteRef = { value: 30 }; // Padrão de 30 minutos

// Referências para valores dos carrosséis do segundo modal (hora final da pausa)
const modalPauseEndHourRef = { value: 0 };
const modalPauseEndMinuteRef = { value: 0 };

// Campos de seleção de tipo de término de pausa (duração ou hora final)
const modalPauseEndTypeRadios = document.querySelectorAll('input[name="modal-pause-end-type"]');
const modalPauseModeDurationRadio = document.getElementById('modal-pause-mode-duration'); // Referência ao radio de duração
const modalCamposDuracao = document.getElementById('modal-campos-duracao');
const modalCamposFim = document.getElementById('modal-campos-fim');
let modalPauseEndTypeSelected = 'duration'; // Padrão

// Checkbox de repetição diária
const modalDailyRepeatCheckbox = document.getElementById('modal-daily-repeat');

// Botões de navegação dos modais
const modalInitialTimeNextButton = document.getElementById('modal-initial-time-next');
const modalDetailsDefineButton = document.getElementById('modal-details-define');
const modalDetailsBackButton = document.getElementById('modal-details-back');

// Elementos do modal de configuração do Gist
const gistTokenInput = document.getElementById('gist-token-input');
const gistIdInput = document.getElementById('gist-id-input');
const saveGistConfigButton = document.getElementById('save-gist-config-button');
const cancelGistConfigButton = document.getElementById('cancel-gist-config-button');

// Variáveis para armazenar o token e ID do Gist (inicialmente do localStorage)
let gistToken = localStorage.getItem('github_pat') || '';
let gistId = localStorage.getItem('gist_id') || '';

// Array para armazenar as pausas ativas
let activePauses = [];

// Para controlar a última data em que o reset diário foi feito
let lastDailyResetDate = localStorage.getItem('lastDailyResetDate');

// Nome do arquivo dentro do Gist
const GIST_FILENAME = 'pomodorus_pauses.json';

// --- CLASSE TimeCarousel ---
class TimeCarousel {
    constructor({ mainCarouselElement, mainItemsContainer, upButton, downButton, selectionOverlay, selectionItemsContainer, currentValueRef, totalItems, hasAmPm = false }) {
        this.mainCarouselElement = mainCarouselElement;
        this.mainItemsContainer = mainItemsContainer;
        this.upButton = upButton;
        this.downButton = downButton;
        this.selectionOverlay = selectionOverlay;
        this.selectionItemsContainer = selectionItemsContainer;
        this.currentValueRef = currentValueRef;
        this.totalItems = totalItems;
        this.hasAmPm = hasAmPm;
        this.isEnabled = true; // Novo estado para habilitar/desabilitar

        this.init();
    }

    init() {
        this.populateMainCarousel();
        this.attachEventListeners();
        this.updateMainCarouselPosition(this.currentValueRef.value); // Garante que a posição inicial esteja correta
    }

    setEnabled(enabled) {
        this.isEnabled = enabled;
        if (this.mainCarouselElement) {
            if (enabled) {
                this.mainCarouselElement.classList.remove('disabled');
            } else {
                this.mainCarouselElement.classList.add('disabled');
            }
        }
        if (this.upButton) this.upButton.disabled = !enabled;
        if (this.downButton) this.downButton.disabled = !enabled;
    }

    formatTime(value) {
        return String(value).padStart(2, '0');
    }

    populateMainCarousel() {
        if (!this.mainItemsContainer) return;

        this.mainItemsContainer.innerHTML = '';
        const items = [];

        // Adiciona itens antes do valor atual para preencher a visualização
        for (let i = -2; i <= 2; i++) {
            let itemValue = (this.currentValueRef.value + i + this.totalItems * 5) % this.totalItems; // +totalItems*5 para lidar com números negativos no módulo
            let displayValue = this.formatTime(itemValue);
            if (this.hasAmPm) {
                displayValue = this.formatAmPm(itemValue);
            }
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('carousel-item');
            if (i === 0) itemDiv.classList.add('active'); // O item central é o ativo
            itemDiv.textContent = displayValue;
            itemDiv.dataset.value = itemValue; // Armazena o valor numérico
            items.push(itemDiv);
        }
        items.forEach(item => this.mainItemsContainer.appendChild(item));
    }

    updateMainCarouselPosition(newValue, animate = false) {
        // Garantir que newValue esteja dentro dos limites
        newValue = (newValue % this.totalItems + this.totalItems) % this.totalItems;
        this.currentValueRef.value = newValue;

        // Repopula o carrossel principal para mostrar os novos itens centrados
        this.populateMainCarousel();

        // Nenhuma transição de scroll real, apenas reposiciona o conteúdo
        if (this.mainItemsContainer) {
            // A "posição" visual já é ajustada pelo populateMainCarousel
        }

        // Se o overlay de seleção estiver aberto, atualize-o também
        if (this.selectionOverlay && this.selectionOverlay.classList.contains('active')) {
            this.populateSelectionOverlay();
        }
    }

    increment() {
        if (!this.isEnabled) return;
        this.updateMainCarouselPosition((this.currentValueRef.value + 1 + this.totalItems) % this.totalItems);
    }

    decrement() {
        if (!this.isEnabled) return;
        this.updateMainCarouselPosition((this.currentValueRef.value - 1 + this.totalItems) % this.totalItems);
    }

    openSelectionOverlay() {
        if (!this.isEnabled) return;
        if (this.selectionOverlay) {
            this.selectionOverlay.classList.add('active');
            this.populateSelectionOverlay();
            this.scrollToCurrentValueInOverlay();
        }
    }

    closeSelectionOverlay() {
        if (this.selectionOverlay) {
            this.selectionOverlay.classList.remove('active');
        }
    }

    populateSelectionOverlay() {
        if (!this.selectionItemsContainer) return;

        this.selectionItemsContainer.innerHTML = '';
        for (let i = 0; i < this.totalItems; i++) {
            let displayValue = this.formatTime(i);
            if (this.hasAmPm) {
                displayValue = this.formatAmPm(i);
            }
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('selection-item');
            if (i === this.currentValueRef.value) {
                itemDiv.classList.add('selected');
            }
            itemDiv.textContent = displayValue;
            itemDiv.dataset.value = i;
            itemDiv.addEventListener('click', () => this.selectValueFromOverlay(i));
            this.selectionItemsContainer.appendChild(itemDiv);
        }
    }

    scrollToCurrentValueInOverlay() {
        if (!this.selectionItemsContainer) return;

        const selectedItem = this.selectionItemsContainer.querySelector('.selection-item.selected');
        if (selectedItem) {
            // Scroll para centralizar o item selecionado
            this.selectionItemsContainer.scrollTop = selectedItem.offsetTop -
                (this.selectionItemsContainer.clientHeight / 2) + (selectedItem.clientHeight / 2);
        }
    }

    selectValueFromOverlay(value) {
        if (!this.isEnabled) return;
        this.updateMainCarouselPosition(value);
        this.closeSelectionOverlay();
    }

    attachEventListeners() {
        if (this.upButton) {
            this.upButton.addEventListener('click', () => this.increment());
        }
        if (this.downButton) {
            this.downButton.addEventListener('click', () => this.decrement());
        }
        if (this.mainCarouselElement) {
            this.mainCarouselElement.addEventListener('click', () => this.openSelectionOverlay());
        }
        if (this.selectionOverlay) {
            this.selectionOverlay.addEventListener('click', (event) => {
                // Fecha o overlay apenas se clicou no fundo, não nos itens
                if (event.target === this.selectionOverlay) {
                    this.closeSelectionOverlay();
                }
            });
        }
    }
}


// --- INSTÂNCIAS DOS CARROSSÉIS (Modais) ---

const modalInitialPauseHourCarousel = new TimeCarousel({
    mainCarouselElement: document.getElementById('modal-initial-pause-hour'),
    mainItemsContainer: document.getElementById('modal-initial-pause-hour-items'),
    upButton: document.querySelector('#modal-initial-pause-hour .carousel-button.up'),
    downButton: document.querySelector('#modal-initial-pause-hour .carousel-button.down'),
    selectionOverlay: document.getElementById('initial-pause-hour-selection-overlay'),
    selectionItemsContainer: document.getElementById('initial-pause-hour-selection-items'),
    currentValueRef: initialPauseHourRef,
    totalItems: 24
});

const modalInitialPauseMinuteCarousel = new TimeCarousel({
    mainCarouselElement: document.getElementById('modal-initial-pause-minute'),
    mainItemsContainer: document.getElementById('modal-initial-pause-minute-items'),
    upButton: document.querySelector('#modal-initial-pause-minute .carousel-button.up'),
    downButton: document.querySelector('#modal-initial-pause-minute .carousel-button.down'),
    selectionOverlay: document.getElementById('initial-pause-minute-selection-overlay'),
    selectionItemsContainer: document.getElementById('initial-pause-minute-selection-items'),
    currentValueRef: initialPauseMinuteRef,
    totalItems: 60
});

const modalPauseDurationHourCarousel = new TimeCarousel({
    mainCarouselElement: document.getElementById('modal-pause-duration-hour'),
    mainItemsContainer: document.getElementById('modal-pause-duration-hour-items'),
    upButton: document.querySelector('#modal-pause-duration-hour .carousel-button.up'),
    downButton: document.querySelector('#modal-pause-duration-hour .carousel-button.down'),
    selectionOverlay: document.getElementById('pause-duration-hour-selection-overlay'),
    selectionItemsContainer: document.getElementById('pause-duration-hour-selection-items'),
    currentValueRef: modalPauseDurationHourRef,
    totalItems: 24 // Duração pode ser até 23 horas
});

const modalPauseDurationMinuteCarousel = new TimeCarousel({
    mainCarouselElement: document.getElementById('modal-pause-duration-minute'),
    mainItemsContainer: document.getElementById('modal-pause-duration-minute-items'),
    upButton: document.querySelector('#modal-pause-duration-minute .carousel-button.up'),
    downButton: document.querySelector('#modal-pause-duration-minute .carousel-button.down'),
    selectionOverlay: document.getElementById('pause-duration-minute-selection-overlay'),
    selectionItemsContainer: document.getElementById('pause-duration-minute-selection-items'),
    currentValueRef: modalPauseDurationMinuteRef,
    totalItems: 60
});

const modalPauseEndHourCarousel = new TimeCarousel({
    mainCarouselElement: document.getElementById('modal-pause-end-hour'),
    mainItemsContainer: document.getElementById('modal-pause-end-hour-items'),
    upButton: document.querySelector('#modal-pause-end-hour .carousel-button.up'),
    downButton: document.querySelector('#modal-pause-end-hour .carousel-button.down'),
    selectionOverlay: document.getElementById('pause-end-hour-selection-overlay'),
    selectionItemsContainer: document.getElementById('pause-end-hour-selection-items'),
    currentValueRef: modalPauseEndHourRef,
    totalItems: 24
});

const modalPauseEndMinuteCarousel = new TimeCarousel({
    mainCarouselElement: document.getElementById('modal-pause-end-minute'),
    mainItemsContainer: document.getElementById('modal-pause-end-minute-items'),
    upButton: document.querySelector('#modal-pause-end-minute .carousel-button.up'),
    downButton: document.querySelector('#modal-pause-end-minute .carousel-button.down'),
    selectionOverlay: document.getElementById('pause-end-minute-selection-overlay'),
    selectionItemsContainer: document.getElementById('pause-end-minute-selection-items'),
    currentValueRef: modalPauseEndMinuteRef,
    totalItems: 60
});


// --- GESTÃO DE PAUSAS (Adicionar, Remover, Notificações, UI) ---

function generateUniqueId() {
    return 'pause-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function showDesktopNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: body });
    }
}

// Renomeada de renderPausesList para updatePausesListUI para consistência
function updatePausesListUI() {
    pausesList.innerHTML = ''; // Limpa a lista existente
    if (activePauses.length === 0) {
        pausesList.innerHTML = '<p class="no-pauses-message">Nenhuma pausa configurada.</p>';
        return;
    }

    activePauses.forEach(pause => {
        const pauseItem = document.createElement('div');
        pauseItem.classList.add('pause-item');
        pauseItem.dataset.id = pause.id;

        const startH = String(pause.startTime.hours).padStart(2, '0');
        const startM = String(pause.startTime.minutes).padStart(2, '0');
        const endH = String(pause.endTime.hours).padStart(2, '0');
        const endM = String(pause.endTime.minutes).padStart(2, '0');

        let pauseText = `Pausa das ${startH}:${startM} às ${endH}:${endM}`;
        if (pause.isDailyRepeat) { // Use isDailyRepeat
            pauseText += ' (Diária)';
        }

        pauseItem.innerHTML = `
            <span>${pauseText}</span>
            <button class="remove-pause-button" data-id="${pause.id}">Remover</button>
        `;
        pausesList.appendChild(pauseItem);
    });

    // Adiciona event listeners para os botões de remover
    document.querySelectorAll('.remove-pause-button').forEach(button => {
        button.addEventListener('click', (event) => {
            const idToRemove = event.target.dataset.id;
            removePause(idToRemove);
        });
    });
}

function addPause(startH, startM, endH, endM, isDailyRepeat) {
    const newPause = {
        id: generateUniqueId(),
        startTime: { hours: startH, minutes: startM },
        endTime: { hours: endH, minutes: endM },
        isDailyRepeat: isDailyRepeat, // Use isDailyRepeat aqui
        lastNotifiedStart: null,
        lastNotifiedEnd: null,
        type: 'end-time' // Assumindo que sempre teremos um end-time definido
    };
    activePauses.push(newPause);
    updatePausesListUI();
    showStatusMessage('Nova pausa configurada!', false);
    console.log('Pausa adicionada:', newPause);

    if (isDailyRepeat) { // Salva no Gist se for uma pausa diária
        savePausesToGist();
    }
}

function removePause(idToRemove) {
    const removedPause = activePauses.find(pause => pause.id === idToRemove);
    activePauses = activePauses.filter(pause => pause.id !== idToRemove);
    updatePausesListUI();
    showStatusMessage('Pausa removida.', false);
    console.log(`Pausa com ID ${idToRemove} removida.`);

    if (removedPause && removedPause.isDailyRepeat) { // Salva no Gist se a pausa removida era diária
        savePausesToGist(true); // Passa true para indicar que a chamada vem de uma remoção
    }
}

// --- LÓGICA DE TEMPO E PAUSAS ATIVAS ---

function updateClockAndCheckPauses() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentSecond = now.getSeconds();

    clockDisplay.textContent = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}:${String(currentSecond).padStart(2, '0')}`;

    // Reset diário de estados de notificação
    const todayDate = now.toDateString();
    if (lastDailyResetDate !== todayDate) {
        activePauses.forEach(pause => {
            pause.lastNotifiedStart = null;
            pause.lastNotifiedEnd = null;
        });
        localStorage.setItem('lastDailyResetDate', todayDate);
        lastDailyResetDate = todayDate;
        console.log('Reset diário de notificações de pausa.');
    }

    let isDuringAPause = false;
    let nextPauseInfo = null;
    let nextPauseTimeDiff = Infinity;

    activePauses.forEach(pause => {
        const startTotalMinutes = pause.startTime.hours * 60 + pause.startTime.minutes;
        const endTotalMinutes = pause.endTime.hours * 60 + pause.endTime.minutes;
        const currentTotalMinutes = currentHour * 60 + currentMinute;

        // Lida com pausas que se estendem para o dia seguinte (ex: 23:00 - 01:00)
        let actualEndTotalMinutes = endTotalMinutes;
        if (endTotalMinutes < startTotalMinutes) {
            actualEndTotalMinutes += 24 * 60; // Adiciona 24 horas em minutos
        }

        let actualCurrentTotalMinutes = currentTotalMinutes;
        if (currentTotalMinutes < startTotalMinutes && endTotalMinutes < startTotalMinutes) {
            actualCurrentTotalMinutes += 24 * 60;
        }

        const isCurrentlyInPause = actualCurrentTotalMinutes >= startTotalMinutes && actualCurrentTotalMinutes < actualEndTotalMinutes;

        if (isCurrentlyInPause) {
            isDuringAPause = true;
            // Notificação de início de pausa
            if (!pause.lastNotifiedStart || pause.lastNotifiedStart !== todayDate) {
                const message = `Pausa das ${String(pause.startTime.hours).padStart(2, '0')}:${String(pause.startTime.minutes).padStart(2, '0')} até ${String(pause.endTime.hours).padStart(2, '0')}:${String(pause.endTime.minutes).padStart(2, '0')}.`;
                showDesktopNotification('Início da Pausa', message);
                pause.lastNotifiedStart = todayDate;
                alarmDisplay.textContent = `Pausa em andamento: ${String(pause.startTime.hours).padStart(2, '0')}:${String(pause.startTime.minutes).padStart(2, '0')} - ${String(pause.endTime.hours).padStart(2, '0')}:${String(pause.endTime.minutes).padStart(2, '0')}`;
                alarmDisplay.style.color = '#00796b';
            }
            currentPauseDisplay.textContent = `Pausa atual: ${String(pause.startTime.hours).padStart(2, '0')}:${String(pause.startTime.minutes).padStart(2, '0')} - ${String(pause.endTime.hours).padStart(2, '0')}:${String(pause.endTime.minutes).padStart(2, '0')}`;
        } else {
            // Notificação de fim de pausa (se a pausa terminou e não foi notificada hoje)
            if (currentTotalMinutes === endTotalMinutes && (!pause.lastNotifiedEnd || pause.lastNotifiedEnd !== todayDate)) {
                if (currentSecond === 0) { // Notifica apenas no minuto 00 para evitar spam
                    const message = `Pausa das ${String(pause.startTime.hours).padStart(2, '0')}:${String(pause.startTime.minutes).padStart(2, '0')} - ${String(pause.endTime.hours).padStart(2, '0')}:${String(pause.endTime.minutes).padStart(2, '0')} terminou.`;
                    showDesktopNotification('Fim da Pausa', message);
                    pause.lastNotifiedEnd = todayDate;
                }
            }

            // Calcular próxima pausa
            let timeToNextPause = (startTotalMinutes - currentTotalMinutes + 24 * 60) % (24 * 60); // Minutos até a próxima pausa
            if (timeToNextPause === 0 && !isCurrentlyInPause) { // Se for 0, mas não está em pausa, significa que a pausa é agora
                 // Isso pode acontecer se a hora de início for a hora atual mas a pausa ainda não foi ativada
                 timeToNextPause = 24 * 60; // Considera para o dia seguinte para evitar conflito com 'em pausa'
            }
            
            if (timeToNextPause > 0 && timeToNextPause < nextPauseTimeDiff) {
                nextPauseTimeDiff = timeToNextPause;
                nextPauseInfo = pause;
            }
        }
    });

    if (!isDuringAPause) {
        currentPauseDisplay.textContent = 'Nenhuma pausa ativa.';
        if (nextPauseInfo) {
            const nextStartH = String(nextPauseInfo.startTime.hours).padStart(2, '0');
            const nextStartM = String(nextPauseInfo.startTime.minutes).padStart(2, '0');
            nextPauseDisplay.textContent = `Próxima pausa: ${nextStartH}:${nextStartM}`;
            alarmDisplay.textContent = `Próxima pausa às ${nextStartH}:${nextStartM}.`;
            alarmDisplay.style.color = '#ff9800'; // Orange for upcoming
        } else {
            nextPauseDisplay.textContent = 'Nenhuma próxima pausa agendada.';
            alarmDisplay.textContent = 'Nenhuma pausa agendada.';
            alarmDisplay.style.color = '#757575'; // Gray for no alarms
        }
    } else {
         nextPauseDisplay.textContent = 'Pausa em andamento...'; // Limpa a mensagem da próxima pausa
    }
}

// Executa a atualização do relógio a cada segundo
setInterval(updateClockAndCheckPauses, 1000);


// --- LÓGICA DE INTEGRAÇÃO COM GIST ---

async function getGistContent(gistId, token) {
    const url = `https://api.github.com/gists/${gistId}`;
    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro ao buscar Gist: ${response.status} ${response.statusText} - ${errorText}`);
        }

        const gist = await response.json();
        // Assume que o arquivo principal é o `GIST_FILENAME`
        const file = gist.files[GIST_FILENAME];
        if (file) {
            return file.content;
        } else {
            // Se o arquivo nomeado não existe, tenta pegar o primeiro arquivo, por compatibilidade
            const filename = Object.keys(gist.files)[0];
            if (filename) {
                console.warn(`Arquivo "${GIST_FILENAME}" não encontrado no Gist. Usando o primeiro arquivo: "${filename}".`);
                return gist.files[filename].content;
            } else {
                return null; // Gist vazio
            }
        }

    } catch (error) {
        console.error('Erro ao buscar Gist:', error);
        showStatusMessage(`Erro ao carregar do Gist: ${error.message}`, true);
        return null;
    }
}

async function updateGistContent(gistId, token, filename, content) {
    const url = `https://api.github.com/gists/${gistId}`;
    const data = {
        description: "Pomodorus Daily Pauses Configuration",
        public: false, // Recomendado para segurança
        files: {
            [filename]: {
                content: content
            }
        }
    };

    try {
        const response = await fetch(url, {
            method: 'PATCH', // Usamos PATCH para atualizar
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro ao atualizar Gist: ${response.status} ${response.statusText} - ${errorText}`);
        }

        await response.json();
        showStatusMessage('Pausas diárias salvas no Gist com sucesso!', false);
        console.log('Gist atualizado com sucesso.');
        return true;

    } catch (error) {
        console.error('Erro ao salvar no Gist:', error);
        showStatusMessage(`Erro ao salvar no Gist: ${error.message}`, true);
        return false;
    }
}


async function loadPausesFromGist() {
    const pat = localStorage.getItem('github_pat');
    const gistIdFromStorage = localStorage.getItem('gist_id');

    if (!pat || !gistIdFromStorage) {
        console.warn('PAT ou Gist ID não configurados. Não foi possível carregar pausas do Gist.');
        showStatusMessage('Gist não configurado para carregar pausas diárias.', true);
        modalDailyRepeatCheckbox.disabled = true;
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Requer Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '#d32f2f';
        return;
    }

    // Atualiza as variáveis globais com os valores do localStorage
    gistToken = pat;
    gistId = gistIdFromStorage;

    try {
        showStatusMessage('Carregando pausas diárias do Gist...', false);
        const content = await getGistContent(gistId, pat);
        
        console.log('Conteúdo do Gist Bruto:', content);

        if (content) {
            let loadedPauses;
            try {
                loadedPauses = JSON.parse(content);
                console.log('Conteúdo do Gist Parsed:', loadedPauses);
            } catch (jsonError) {
                console.error('Erro ao parsear JSON do Gist:', jsonError);
                throw new Error(`Erro ao parsear JSON do Gist: ${jsonError.message}. Conteúdo inválido.`);
            }

            if (!Array.isArray(loadedPauses)) {
                console.warn("Conteúdo do Gist não é um array. Ignorando.");
                throw new Error("Conteúdo do Gist não é um array de pausas. Formato inválido.");
            }

            // Filtra e adiciona apenas pausas diárias carregadas que são válidas
            // Remove pausas diárias antigas da memória (apenas as que são de repetição diária)
            activePauses = activePauses.filter(pause => !pause.isDailyRepeat); 
            
            const validLoadedPauses = [];
            loadedPauses.forEach(loadedPause => {
                // Validação para a sua estrutura de objeto de pausa:
                const isValidPause = 
                    typeof loadedPause === 'object' && loadedPause !== null &&
                    typeof loadedPause.startTime === 'object' && loadedPause.startTime !== null &&
                    typeof loadedPause.startTime.hours === 'number' &&
                    typeof loadedPause.startTime.minutes === 'number' &&
                    typeof loadedPause.endTime === 'object' && loadedPause.endTime !== null &&
                    typeof loadedPause.endTime.hours === 'number' &&
                    typeof loadedPause.endTime.minutes === 'number' &&
                    typeof loadedPause.dailyRepeat === 'boolean'; // Usa 'dailyRepeat' como no seu objeto

                console.log('Validando pausa:', loadedPause, 'Resultado:', isValidPause);

                if (isValidPause) {
                    // Reinicia estados para o novo dia
                    loadedPause.lastNotifiedStart = null;
                    loadedPause.lastNotifiedEnd = null;
                    // Garante que o ID é único
                    loadedPause.id = loadedPause.id || generateUniqueId();
                    // Garante que 'isDailyRepeat' esteja definido para o resto do app
                    loadedPause.isDailyRepeat = loadedPause.dailyRepeat; 

                    validLoadedPauses.push(loadedPause);
                } else {
                    console.warn("Pausa inválida encontrada no Gist e ignorada:", loadedPause);
                    showStatusMessage("Atenção: Algumas pausas no Gist estão com formato inválido e foram ignoradas.", true);
                }
            });

            if (validLoadedPaases.length > 0) {
                activePauses.push(...validLoadedPauses); // Adiciona as pausas válidas
                updatePausesListUI();
                showStatusMessage('Pausas diárias carregadas do Gist!', false);
                console.log('Pausas diárias carregadas:', activePauses.filter(p => p.isDailyRepeat));
            } else {
                 showStatusMessage('Gist encontrado, mas não contém pausas diárias válidas.', true);
                 console.log('Nenhuma pausa diária válida encontrada no Gist.');
            }
            
            // Habilita o checkbox se o carregamento foi bem-sucedido
            modalDailyRepeatCheckbox.disabled = false;
            modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Gist configurado)';
            modalDailyRepeatCheckbox.nextElementSibling.style.color = '';

        } else {
            showStatusMessage('Gist encontrado, mas sem conteúdo.', true);
        }
    } catch (error) {
        console.error('Erro ao processar pausas do Gist:', error);
        showStatusMessage(`Erro ao carregar pausas: ${error.message}`, true);
        modalDailyRepeatCheckbox.disabled = true;
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Erro no Gist)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '#d32f2f';
    }
}

async function savePausesToGist(fromRemove = false) {
    const pat = localStorage.getItem('github_pat');
    const gistIdFromStorage = localStorage.getItem('gist_id');

    if (!pat || !gistIdFromStorage) {
        if (fromRemove) {
            console.warn("Gist não configurado, não é possível salvar alterações de pausas.");
            return;
        }
        showStatusMessage('Gist não configurado. Não é possível salvar pausas diárias.', true);
        return;
    }

    // Pega apenas as pausas que são de repetição diária
    // Usa 'isDailyRepeat' para filtrar
    const pausesToSave = activePauses.filter(pause => pause.isDailyRepeat);
    // Remove 'isDailyRepeat' e outras propriedades temporárias para salvar no Gist
    const cleanedPauses = pausesToSave.map(p => {
        const { isDailyRepeat, triggeredStartForToday, triggeredEndForToday, isActive, ...rest } = p;
        return rest; // Retorna o objeto sem as propriedades temporárias
    });

    const gistContent = JSON.stringify(cleanedPauses, null, 2);

    try {
        showStatusMessage('Salvando pausas diárias no Gist...', false);
        const success = await updateGistContent(gistIdFromStorage, pat, GIST_FILENAME, gistContent);
        if (success) {
            showStatusMessage('Pausas diárias salvas no Gist!', false);
            console.log('Pausas diárias salvas:', cleanedPauses);
        }
    } catch (error) {
        showStatusMessage(`Erro de rede ao salvar Gist: ${error.message}.`, true);
        console.error('Erro de rede ao salvar Gist:', error);
    }
}

function showStatusMessage(message, isError = false) {
    alarmDisplay.textContent = message;
    alarmDisplay.style.color = isError ? '#d32f2f' : '#00796b';
}


// --- LÓGICA DE INTERAÇÃO DA UI E EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    // Inicializa carrosséis dos modais
    modalInitialPauseHourCarousel.setEnabled(true);
    modalInitialPauseMinuteCarousel.setEnabled(true);

    // Lógica para alternar campos de Duração/Fim dentro do modal de detalhes
    function toggleModalPauseEndFields() {
        modalPauseEndTypeSelected = document.querySelector('input[name="modal-pause-end-type"]:checked').value;

        modalPauseDurationHourCarousel.setEnabled(false);
        modalPauseDurationMinuteCarousel.setEnabled(false);
        modalPauseEndHourCarousel.setEnabled(false);
        modalPauseEndMinuteCarousel.setEnabled(false);

        modalCamposDuracao.style.display = 'none';
        modalCamposFim.style.display = 'none';

        if (modalPauseEndTypeSelected === 'duration') {
            modalCamposDuracao.style.display = 'flex';
            modalPauseDurationHourCarousel.setEnabled(true);
            modalPauseDurationMinuteCarousel.setEnabled(true);
        } else {
            modalCamposFim.style.display = 'flex';
            modalPauseEndHourCarousel.setEnabled(true);
            modalPauseEndMinuteCarousel.setEnabled(true);
        }
    }

    modalPauseEndTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleModalPauseEndFields);
    });

    updatePausesListUI(); // Renderiza a lista de pausas inicial

    // Sincroniza os valores iniciais dos carrosséis dos modais
    modalInitialPauseHourCarousel.updateMainCarouselPosition(initialPauseHourRef.value);
    modalInitialPauseMinuteCarousel.updateMainPauseMinuteRef.value);
    modalPauseDurationHourCarousel.updateMainCarouselPosition(modalPauseDurationHourRef.value);
    modalPauseDurationMinuteCarousel.updateMainCarouselPosition(modalPauseDurationMinuteRef.value);
    modalPauseEndHourCarousel.updateMainCarouselPosition(modalPauseEndHourRef.value);
    modalPauseEndMinuteCarousel.updateMainCarouselPosition(modalPauseEndMinuteRef.value);

    // Carrega a configuração do Gist se existir e tenta carregar pausas
    const gistTokenStored = localStorage.getItem('github_pat');
    const gistIdStored = localStorage.getItem('gist_id');

    // Preenche os inputs do Gist modal se os valores estiverem armazenados
    gistTokenInput.value = gistTokenStored || '';
    gistIdInput.value = gistIdStored || '';


    if (gistTokenStored && gistIdStored) {
        // Assegura que as variáveis globais sejam atualizadas
        gistToken = gistTokenStored;
        gistId = gistIdStored;
        loadPausesFromGist(); // Tenta carregar pausas automaticamente
    } else {
        // Se não houver token ou ID do gist, desabilita a repetição diária
        modalDailyRepeatCheckbox.disabled = true;
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Requer Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '#d32f2f';
    }

    // Solicita permissão para notificações
    if ('Notification' in window) {
        Notification.requestPermission();
    }
    updateClockAndCheckPauses(); // Executa ao carregar para mostrar o relógio e estado inicial
});


// --- Lógica de Abertura e Navegação dos Modais de Configuração ---

openPauseConfigModalButton.addEventListener('click', () => {
    // Abre o primeiro modal e fecha o segundo, se estiver aberto
    modalPauseDetails.classList.remove('active');
    modalInitialTime.classList.add('active');

    // Reseta valores dos carrosseis do modal 1 para a hora atual
    const now = new Date();
    initialPauseHourRef.value = now.getHours();
    initialPauseMinuteRef.value = now.getMinutes();
    modalInitialPauseHourCarousel.updateMainCarouselPosition(initialPauseHourRef.value);
    modalInitialPauseMinuteCarousel.updateMainCarouselPosition(initialPauseMinuteRef.value);

    // Reseta a seleção de duração/fim para padrão (duração)
    modalPauseModeDurationRadio.checked = true;
    // Chama a função para garantir que os campos de duração/fim sejam exibidos corretamente
    document.querySelector('input[name="modal-pause-end-type"]:checked').dispatchEvent(new Event('change'));

    // Redefine os valores dos carrosséis de duração/fim para padrão (ex: 0h 30m)
    modalPauseDurationHourRef.value = 0;
    modalPauseDurationMinuteRef.value = 30;
    modalPauseDurationHourCarousel.updateMainCarouselPosition(modalPauseDurationHourRef.value);
    modalPauseDurationMinuteCarousel.updateMainCarouselPosition(modalPauseDurationMinuteRef.value);

    // Habilita/Desabilita o checkbox baseado no Gist ao abrir
    const gistTokenStored = localStorage.getItem('github_pat');
    const gistIdStored = localStorage.getItem('gist_id');

    if (gistTokenStored && gistIdStored) {
        modalDailyRepeatCheckbox.disabled = false;
        modalDailyRepeatCheckbox.checked = false; // Garante que esteja desmarcado ao abrir novo
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '';
    } else {
        modalDailyRepeatCheckbox.disabled = true;
        modalDailyRepeatCheckbox.checked = false;
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Requer Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '#d32f2f';
    }
});

modalInitialTimeNextButton.addEventListener('click', () => {
    // Fecha o primeiro modal e abre o segundo
    modalInitialTime.classList.remove('active');
    modalPauseDetails.classList.add('active');

    // Assegura que o estado inicial do segundo modal seja correto
    document.querySelector('input[name="modal-pause-end-type"]:checked').dispatchEvent(new Event('change'));
    
    // Habilita/Desabilita o checkbox de repetição diária com base na configuração do Gist
    const gistTokenStored = localStorage.getItem('github_pat');
    const gistIdStored = localStorage.getItem('gist_id');
    modalDailyRepeatCheckbox.disabled = (!gistTokenStored || !gistIdStored);

    if (modalDailyRepeatCheckbox.disabled) {
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Requer Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '#d32f2f';
    } else {
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '';
    }
});

modalDetailsBackButton.addEventListener('click', () => {
    // Volta para o primeiro modal
    modalPauseDetails.classList.remove('active');
    modalInitialTime.classList.add('active');
});

// Lógica para fechar os modais clicando fora deles
modalInitialTime.addEventListener('click', (event) => {
    if (event.target === modalInitialTime) {
        modalInitialTime.classList.remove('active');
    }
});

modalPauseDetails.addEventListener('click', (event) => {
    if (event.target === modalPauseDetails) {
        modalPauseDetails.classList.remove('active');
    }
});


// --- Lógica de Definição de Pausa (agora no segundo modal) ---
modalDetailsDefineButton.addEventListener('click', () => {
    // Fecha os modais de configuração
    modalInitialTime.classList.remove('active');
    modalPauseDetails.classList.remove('active');

    const startHour = initialPauseHourRef.value;
    const startMinute = initialPauseMinuteRef.value;
    
    // Calcula endTime (mesmo que a opção seja 'duration')
    let calculatedEndTime = { hours: 0, minutes: 0 };
    if (modalPauseEndTypeSelected === 'duration') {
        const durationHours = modalPauseDurationHourRef.value;
        const durationMinutes = modalPauseDurationMinuteRef.value;
        let totalStartMinutes = (startHour * 60) + startMinute;
        let totalEndMinutes = totalStartMinutes + (durationHours * 60) + durationMinutes;
        calculatedEndTime.hours = Math.floor(totalEndMinutes / 60) % 24;
        calculatedEndTime.minutes = totalEndMinutes % 60;
    } else { // 'end-time'
        calculatedEndTime.hours = modalPauseEndHourRef.value;
        calculatedEndTime.minutes = modalPauseEndMinuteRef.value;
    }

    let newPause = {
        id: generateUniqueId(),
        startTime: { hours: startHour, minutes: startMinute },
        type: modalPauseEndTypeSelected, // 'duration' or 'end-time'
        dailyRepeat: modalDailyRepeatCheckbox.checked, // Usa 'dailyRepeat' para o objeto de pausa
        isDailyRepeat: modalDailyRepeatCheckbox.checked, // Adiciona 'isDailyRepeat' para compatibilidade
        lastNotifiedStart: null,
        lastNotifiedEnd: null,
        endTime: calculatedEndTime // Adiciona endTime calculada à pausa
    };

    let message = '';
    if (newPause.type === 'duration') {
        const durationHours = modalPauseDurationHourRef.value;
        const durationMinutes = modalPauseDurationMinuteRef.value;
        newPause.duration = { hours: durationHours, minutes: durationMinutes };
        message = `Pausa das ${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')} por ${String(durationHours).padStart(2, '0')}h ${String(durationMinutes).padStart(2, '0')}m (Termina às ${String(calculatedEndTime.hours).padStart(2, '0')}:${String(calculatedEndTime.minutes).padStart(2, '0')})`;
    } else { // newPause.type === 'end-time'
        message = `Pausa das ${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')} até às ${String(calculatedEndTime.hours).padStart(2, '0')}:${String(calculatedEndTime.minutes).padStart(2, '0')}`;
    }

    if (newPause.isDailyRepeat) { // Usa newPause.isDailyRepeat para a lógica
        message += ' (Diária)';
        const gistTokenStored = localStorage.getItem('github_pat');
        const gistIdStored = localStorage.getItem('gist_id');
        if (!gistTokenStored || !gistIdStored) {
            alert("Para definir pausas diárias, você precisa configurar seu Token e ID do Gist. Clique em 'Carregar/Salvar Pausas (Gist)'.");
            return; // Impede a criação da pausa diária sem Gist
        }
    }

    activePauses.push(newPause);
    updatePausesListUI(); // Renomeada de renderPausesList
    alarmDisplay.textContent = message;
    alarmDisplay.style.color = '#00796b'; // Green for success

    showDesktopNotification('Pausa Definida', message);

    // Se for uma pausa diária, tenta salvar no Gist
    if (newPause.isDailyRepeat) { // Usa newPause.isDailyRepeat
        savePausesToGist();
    }
});


// --- Lógica do Gist (Carregar/Salvar Pausas) ---

manageGistButton.addEventListener('click', () => {
    // Abre o modal de configuração do Gist
    gistTokenInput.value = localStorage.getItem('github_pat') || '';
    gistIdInput.value = localStorage.getItem('gist_id') || '';
    gistConfigModal.classList.add('active');
});

cancelGistConfigButton.addEventListener('click', () => {
    gistConfigModal.classList.remove('active');
});

saveGistConfigButton.addEventListener('click', async () => {
    const pat = gistTokenInput.value.trim();
    const gistIdVal = gistIdInput.value.trim();

    if (!pat || !gistIdVal) {
        showStatusMessage('Token PAT e Gist ID são obrigatórios para integração com Gist.', true);
        modalDailyRepeatCheckbox.disabled = true;
        modalDailyRepeatCheckbox.checked = false;
        modalDailyRepeatCheckbox.nextElementSibling.textContent = 'Repetição Diária (Requer Gist configurado)';
        modalDailyRepeatCheckbox.nextElementSibling.style.color = '#d32f2f';
        return;
    }

    localStorage.setItem('github_pat', pat);
    localStorage.setItem('gist_id', gistIdVal);
    
    // Atualiza as variáveis globais
    gistToken = pat;
    gistId = gistIdVal;

    gistConfigModal.classList.remove('active');
    await loadPausesFromGist(); // Tenta carregar as pausas após salvar a config
});

// Desabilita o checkbox de repetição diária se o Gist não estiver configurado
modalDailyRepeatCheckbox.addEventListener('change', () => {
    const gistTokenStored = localStorage.getItem('github_pat');
    const gistIdStored = localStorage.getItem('gist_id');

    if (modalDailyRepeatCheckbox.checked && (!gistTokenStored || !gistIdStored)) {
        alert("Para usar a repetição diária, você precisa configurar seu Token e ID do Gist. Clique em 'Carregar/Salvar Pausas (Gist)'.");
        modalDailyRepeatCheckbox.checked = false; // Desmarca se não puder usar
    }
});
    </script>
</body>
</html>
